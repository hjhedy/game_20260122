<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>å¿˜å¹´æœƒ Emoji çŒœè¬å¤§è³½</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .emoji { font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif; }
    
    /* iOS è¼¸å…¥æ¡†ä¿®æ­£ */
    input[type="text"] {
      font-size: 18px !important;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border-radius: 16px;
    }
    input[type="text"]:focus {
      outline: none;
      font-size: 18px !important;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app">
    <div class="min-h-screen flex items-center justify-center">
      <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script>
    // ========== Firebase è¨­å®š ==========
    const firebaseConfig = {
      apiKey: "AIzaSyAACLIiJcgtzUjJOGwMbvIXvlAY-rAS2Mw",
      authDomain: "project-3076283348011523398.firebaseapp.com",
      databaseURL: "https://project-3076283348011523398-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "project-3076283348011523398",
      storageBucket: "project-3076283348011523398.firebasestorage.app",
      messagingSenderId: "108187479133",
      appId: "1:108187479133:web:f9a75c4b02da8a9c1bf1b4"
    };

    let db = null;
    
    // ç­‰å¾… Firebase è¼‰å…¥
    function initFirebaseConnection() {
      try {
        if (typeof firebase !== 'undefined') {
          firebase.initializeApp(firebaseConfig);
          db = firebase.database();
          console.log('âœ… Firebase connected');
          initFirebaseListeners();
        } else {
          console.log('âš ï¸ Firebase not loaded, retrying...');
          setTimeout(initFirebaseConnection, 500);
        }
      } catch(e) {
        console.log('Firebase error:', e);
      }
    }

    // ========== é¡Œåº« ==========
    const ALL_QUESTIONS = [
      // ç·´ç¿’é¡Œ (2é¡Œ)
      { emoji: 'ğŸ§…â›½ğŸ«“', answer: 'è”¥æ²¹é¤…', hint: 'æ—©é¤', explain: 'è”¥ï¼‹æ²¹ï¼‹é¤…', round: 'ç·´ç¿’' },
      { emoji: 'ğŸš—ğŸ’¦ğŸğŸ²', answer: 'è»Šæ°´é¦¬é¾', hint: 'æˆèª', explain: 'è»Šï¼‹æ°´ï¼‹é¦¬ï¼‹é¾', round: 'ç·´ç¿’' },
      // Açµ„ (7é¡Œ)
      { emoji: 'ğŸ«…ğŸŒ°ğŸŒˆ', answer: 'ç‹åŠ›å®', hint: 'æ­Œæ‰‹', explain: 'ç‹ï¼‹åŠ›ï¼‹å®', round: 'Açµ„' },
      { emoji: 'ğŸ¥—1ï¸âƒ£ğŸŒ³', answer: 'è”¡ä¾æ—', hint: 'æ­Œæ‰‹', explain: 'è”¡ï¼‹ä¾ï¼‹æ—', round: 'Açµ„' },
      { emoji: 'ğŸŒ¹ğŸª¶ğŸ°', answer: 'ç´…æ¯›åŸ', hint: 'å¤è¹Ÿ', explain: 'ç´…ï¼‹æ¯›ï¼‹åŸ', round: 'Açµ„' },
      { emoji: 'ğŸ®ğŸ–ğŸœ', answer: 'ç‰›è‚‰éºµ', hint: 'ç¾é£Ÿ', explain: 'ç‰›ï¼‹è‚‰ï¼‹éºµ', round: 'Açµ„' },
      { emoji: 'ğŸ·ğŸ©¸ğŸ°', answer: 'è±¬è¡€ç³•', hint: 'å°åƒ', explain: 'è±¬ï¼‹è¡€ï¼‹ç³•', round: 'Açµ„' },
      { emoji: 'ğŸ¦†ğŸ‘…ğŸ§¢', answer: 'é´¨èˆŒå¸½', hint: 'ç©¿æˆ´', explain: 'é´¨ï¼‹èˆŒï¼‹å¸½', round: 'Açµ„' },
      { emoji: 'ğŸ–¼ï¸ğŸâ•ğŸ¦¶', answer: 'ç•«è›‡æ·»è¶³', hint: 'æˆèª', explain: 'ç•«ï¼‹è›‡ï¼‹æ·»ï¼‹è¶³', round: 'Açµ„' },
      // Bçµ„ (7é¡Œ)
      { emoji: 'ğŸ…ğŸ—£ï¸ğŸğŸ‘', answer: 'è™é ­è›‡å°¾', hint: 'æˆèª', explain: 'è™ï¼‹é ­ï¼‹è›‡ï¼‹å°¾', round: 'Bçµ„' },
      { emoji: 'â˜€ï¸ğŸŒ™ğŸŒŠ', answer: 'æ—¥æœˆæ½­', hint: 'æ™¯é»', explain: 'æ—¥ï¼‹æœˆï¼‹æ½­', round: 'Bçµ„' },
      { emoji: 'ğŸ”âœˆï¸ğŸ•ğŸ¦˜', answer: 'é›é£›ç‹—è·³', hint: 'æˆèª', explain: 'é›ï¼‹é£›ï¼‹ç‹—ï¼‹è·³', round: 'Bçµ„' },
      { emoji: 'ğŸŒ¶ï¸ğŸ‘¶ğŸ”', answer: 'è¾£å­é›', hint: 'å·èœ', explain: 'è¾£ï¼‹å­ï¼‹é›', round: 'Bçµ„' },
      { emoji: 'ğŸ‘ğŸ–ğŸ§µ', answer: 'ç¾Šè‚‰ä¸²', hint: 'ç‡’çƒ¤', explain: 'ç¾Šï¼‹è‚‰ï¼‹ä¸²', round: 'Bçµ„' },
      { emoji: 'ğŸ¥¬ğŸ—£ï¸ğŸ“', answer: 'èœè‹±æ–‡', hint: 'å½¢å®¹', explain: 'èœï¼‹è‹±ï¼‹æ–‡', round: 'Bçµ„' },
      { emoji: 'ğŸ’£ğŸ”ğŸ¦µ', answer: 'ç‚¸é›è…¿', hint: 'é€Ÿé£Ÿ', explain: 'ç‚¸ï¼‹é›ï¼‹è…¿', round: 'Bçµ„' },
      // æŒ‘æˆ°é¡Œ (2é¡Œ)
      { emoji: 'ğŸ’°ğŸª¡ğŸ„', answer: 'é‡‘é‡è‡', hint: 'è”¬èœ', explain: 'é‡‘ï¼‹é‡ï¼‹è‡', round: 'æŒ‘æˆ°' },
      { emoji: 'ğŸ´ğŸ”œâœ…ğŸ†', answer: 'é¦¬åˆ°æˆåŠŸ', hint: 'ç¥ç¦', explain: 'é¦¬ï¼‹åˆ°ï¼‹æˆï¼‹åŠŸ', round: 'æŒ‘æˆ°' },
    ];

    const TOTAL = ALL_QUESTIONS.length;
    const HOST_PWD = '2024';
    const TIME_LIMIT = 20;

    // ========== ç‹€æ…‹ ==========
    let state = {
      screen: 'welcome',
      isHost: false,
      name: localStorage.getItem('playerName') || '',
      game: {
        on: false,
        q: 0,
        time: TIME_LIMIT,
        reveal: false,
        done: false
      },
      ans: '',
      score: 0,
      submitted: false,
      hinted: false,
      board: []
    };

    let timer = null;
    let inputEl = null;

    // ========== Firebase ==========
    function initFirebaseListeners() {
      if (!db) return;
      
      db.ref('game').on('value', snap => {
        const d = snap.val();
        if (d) {
          const oldQ = state.game.q;
          const wasReveal = state.game.reveal;
          const wasOn = state.game.on;
          
          state.game = d;
          
          // æ–°é¡Œç›®
          if (d.q !== oldQ) {
            state.ans = '';
            state.submitted = false;
            state.hinted = false;
          }
          
          // ä¸»æŒäººè¨ˆæ™‚
          if (state.isHost && d.on && !d.reveal && !d.done) {
            startHostTimer();
          }
          
          // é‡è¦è®ŠåŒ–æ‰é‡ç¹ª
          if (d.on !== wasOn || d.reveal !== wasReveal || d.q !== oldQ || d.done) {
            draw();
          }
        }
      });
      
      db.ref('board').on('value', snap => {
        const d = snap.val();
        state.board = d ? Object.values(d).sort((a,b) => b.score - a.score) : [];
        // ä¸è¦åœ¨è¼¸å…¥æ™‚é‡ç¹ª
        if (document.activeElement?.id !== 'ans') {
          draw();
        }
      });
    }

    function setGame(obj) {
      if (db) db.ref('game').update(obj);
    }

    function saveScore() {
      if (!db || !state.name) return;
      const id = state.name.replace(/[.#$\/\[\]]/g, '_');
      db.ref('board/' + id).set({ name: state.name, score: state.score });
    }

    function resetAll() {
      if (!confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) return;
      if (db) {
        db.ref('game').set({ on: false, q: 0, time: TIME_LIMIT, reveal: false, done: false });
        db.ref('board').remove();
      }
      state.score = 0;
      state.ans = '';
      state.submitted = false;
      draw();
    }

    // ========== è¨ˆæ™‚ ==========
    function startHostTimer() {
      stopTimer();
      timer = setInterval(() => {
        if (state.game.time > 1 && !state.game.reveal) {
          setGame({ time: state.game.time - 1 });
        } else if (state.game.time <= 1 && !state.game.reveal) {
          stopTimer();
          setGame({ time: 0, reveal: true });
        }
      }, 1000);
    }

    function stopTimer() {
      if (timer) { clearInterval(timer); timer = null; }
    }

    // ========== å‹•ä½œ ==========
    function startGame() {
      setGame({ on: true, q: 0, time: TIME_LIMIT, reveal: false, done: false });
    }

    function nextQ() {
      stopTimer();
      if (state.game.q + 1 >= TOTAL) {
        setGame({ done: true, reveal: false });
      } else {
        setGame({ q: state.game.q + 1, time: TIME_LIMIT, reveal: false });
      }
    }

    function submit() {
      if (state.submitted || !state.ans.trim()) return;
      state.submitted = true;
      
      const q = ALL_QUESTIONS[state.game.q];
      if (state.ans.trim() === q.answer) {
        const bonus = Math.floor(state.game.time / 2);
        const penalty = state.hinted ? 5 : 0;
        state.score += Math.max(10 - penalty + bonus, 5);
        saveScore();
      }
      draw();
    }

    function getRank() {
      const i = state.board.findIndex(p => p.name === state.name);
      return i >= 0 ? i + 1 : null;
    }

    // ========== ç•«é¢ ==========
    function draw() {
      const app = document.getElementById('app');
      
      // è‡ªå‹•è·³è½‰
      if (state.game.on && !state.game.done && state.screen === 'lobby') {
        state.screen = 'game';
      }
      if (state.game.done && state.screen === 'game') {
        state.screen = 'result';
      }
      if (!state.game.on && !state.game.done && state.screen === 'game') {
        state.screen = 'lobby';
      }
      
      let html = '';
      switch(state.screen) {
        case 'welcome': html = welcomeHTML(); break;
        case 'lobby': html = lobbyHTML(); break;
        case 'game': html = gameHTML(); break;
        case 'result': html = resultHTML(); break;
        default: html = welcomeHTML();
      }
      
      app.innerHTML = html;
      bindEvents();
    }

    function welcomeHTML() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-600 via-orange-500 to-yellow-400 flex items-center justify-center p-4">
          <div class="bg-white/95 rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
            <div class="emoji text-7xl mb-4">ğŸŠ</div>
            <h1 class="text-4xl font-black text-gray-800 mb-2">å¿˜å¹´æœƒ</h1>
            <h2 class="text-2xl font-bold text-orange-500 mb-8">Emoji çŒœè¬å¤§è³½</h2>
            <button id="btnP" class="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl font-bold text-xl mb-3">
              ğŸ‘¤ æˆ‘æ˜¯ç©å®¶
            </button>
            <button id="btnH" class="w-full py-3 bg-gray-100 text-gray-600 rounded-2xl font-medium">
              ğŸ¤ ä¸»æŒäºº
            </button>
          </div>
        </div>
      `;
    }

    function lobbyHTML() {
      const n = state.board.length;
      
      if (state.isHost) {
        return `
          <div class="min-h-screen bg-gradient-to-br from-gray-800 to-gray-900 p-4">
            <div class="max-w-lg mx-auto">
              <div class="bg-white rounded-3xl shadow-2xl p-6 mb-4">
                <h2 class="text-2xl font-black text-center mb-6">ğŸ¤ ä¸»æŒäºº</h2>
                <div class="bg-blue-50 rounded-2xl p-4 mb-6 text-center">
                  <p class="text-blue-600 font-bold text-lg">${n} ä½ç©å®¶å·²åŠ å…¥</p>
                </div>
                <button id="btnStart" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl font-bold text-xl mb-4">
                  ğŸš€ é–‹å§‹éŠæˆ²
                </button>
                <button id="btnReset" class="w-full py-2 text-red-400 text-sm">ğŸ—‘ï¸ é‡ç½®</button>
              </div>
              <div class="bg-white/90 rounded-2xl p-4">
                <h3 class="font-bold mb-3">ğŸ“‹ ç©å®¶åˆ—è¡¨</h3>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                  ${n === 0 ? '<p class="text-gray-400 text-center py-4">ç­‰å¾…ä¸­...</p>' :
                    state.board.map(p => `<div class="bg-gray-50 rounded-xl px-4 py-2">${p.name}</div>`).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-600 via-orange-500 to-yellow-400 flex items-center justify-center p-4">
          <div class="bg-white/95 rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
            <div class="emoji text-6xl mb-4">â³</div>
            <h2 class="text-2xl font-black mb-2">ç­‰å¾…é–‹å§‹</h2>
            <p class="text-gray-500 mb-6">${state.name}</p>
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-6">
              <div class="animate-pulse">
                <div class="w-12 h-12 bg-yellow-300 rounded-full mx-auto mb-3"></div>
                <p class="text-yellow-700">ç­‰å¾…ä¸»æŒäºº...</p>
                <p class="text-yellow-600 text-sm mt-2">${n} ä½ç©å®¶</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function gameHTML() {
      const q = ALL_QUESTIONS[state.game.q];
      const pct = ((state.game.q + 1) / TOTAL) * 100;
      const t = state.game.time;
      const show = state.game.reveal;
      const correct = state.submitted && state.ans.trim() === q.answer;
      
      if (show) {
        // ç­”æ¡ˆæ­æ›‰ç•«é¢
        return `
          <div class="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-600 p-4">
            <div class="max-w-2xl mx-auto">
              <div class="bg-white/20 rounded-full h-2 mb-4">
                <div class="bg-white h-full rounded-full" style="width:${pct}%"></div>
              </div>
              <div class="text-white text-center mb-4">
                <span class="font-bold">${q.round}</span>
                <span class="opacity-70 ml-2">${state.game.q + 1}/${TOTAL}</span>
              </div>
              
              <div class="bg-white rounded-3xl shadow-2xl p-6 mb-4">
                <div class="emoji text-6xl text-center mb-4">${q.emoji}</div>
                <div class="bg-green-100 border-2 border-green-400 rounded-2xl p-6 text-center mb-4">
                  <p class="text-green-600 font-bold mb-2">âœ… ç­”æ¡ˆ</p>
                  <p class="text-4xl font-black text-green-700">${q.answer}</p>
                  <p class="text-green-600 mt-2">${q.explain}</p>
                </div>
                ${!state.isHost ? `
                  <div class="text-center py-2 rounded-xl ${correct ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'} font-bold">
                    ${correct ? 'ğŸ‰ ç­”å°äº†ï¼' : (state.submitted ? 'âŒ ç­”éŒ¯äº†' : 'â° æœªä½œç­”')}
                  </div>
                ` : ''}
              </div>
              
              <div class="bg-white rounded-3xl shadow-2xl p-6 mb-4">
                <h3 class="text-xl font-black text-center mb-4">ğŸ† æ’è¡Œæ¦œ</h3>
                <div class="space-y-2 max-h-48 overflow-y-auto">
                  ${state.board.slice(0,10).map((p,i) => `
                    <div class="flex justify-between items-center rounded-xl px-4 py-2 ${i<3?'bg-yellow-50':'bg-gray-50'} ${p.name===state.name?'ring-2 ring-orange-400':''}">
                      <div class="flex items-center gap-2">
                        <span class="emoji">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</span>
                        <span class="font-bold">${p.name}</span>
                      </div>
                      <span class="font-black text-orange-500">${p.score}</span>
                    </div>
                  `).join('')}
                  ${state.board.length === 0 ? '<p class="text-gray-400 text-center py-4">å°šç„¡</p>' : ''}
                </div>
              </div>
              
              ${state.isHost ? `
                <button id="btnNext" class="w-full py-4 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl font-bold text-xl">
                  ${state.game.q + 1 >= TOTAL ? 'ğŸ çµæœ' : 'â¡ï¸ ä¸‹ä¸€é¡Œ'}
                </button>
              ` : '<p class="text-center text-white/80">ç­‰å¾…ä¸‹ä¸€é¡Œ...</p>'}
            </div>
          </div>
        `;
      }
      
      // ç­”é¡Œç•«é¢
      return `
        <div class="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-600 p-4">
          <div class="max-w-lg mx-auto">
            <div class="bg-white/20 rounded-full h-2 mb-4">
              <div class="bg-white h-full rounded-full" style="width:${pct}%"></div>
            </div>
            <div class="flex justify-between items-center text-white mb-4">
              <div>
                <span class="font-bold">${q.round}</span>
                <span class="opacity-70 ml-2">${state.game.q + 1}/${TOTAL}</span>
              </div>
              <div class="text-3xl font-black ${t <= 5 ? 'text-red-300 animate-pulse' : ''}">
                â±ï¸ ${t}
              </div>
            </div>
            
            <div class="bg-white rounded-3xl shadow-2xl p-6">
              <div class="emoji text-6xl text-center mb-4">${q.emoji}</div>
              ${state.hinted ? `<div class="text-center mb-4"><span class="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full text-sm">ğŸ’¡ ${q.hint}</span></div>` : ''}
              
              ${state.isHost ? `
                <div class="bg-gray-50 rounded-2xl p-4 text-center text-gray-600">
                  â³ ç­‰å¾…ç©å®¶ä½œç­”...
                </div>
              ` : (state.submitted ? `
                <div class="bg-blue-50 rounded-2xl p-4 text-center">
                  <p class="text-blue-600 font-bold">å·²é€å‡ºï¼š${state.ans}</p>
                  <p class="text-blue-500 text-sm mt-1">ç­‰å¾…æ­æ›‰...</p>
                </div>
              ` : `
                <div class="space-y-3">
                  <input type="text" id="ans" 
                    placeholder="è¼¸å…¥ç­”æ¡ˆ..."
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    spellcheck="false"
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-2xl text-center font-medium text-lg">
                  <div class="flex gap-3">
                    <button id="btnSub" class="flex-1 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl font-bold text-lg">
                      é€å‡º
                    </button>
                    <button id="btnTip" ${state.hinted?'disabled':''} class="px-5 py-4 bg-yellow-400 text-yellow-900 rounded-2xl font-bold text-lg disabled:opacity-40">
                      ğŸ’¡
                    </button>
                  </div>
                </div>
              `)}
              
              ${!state.isHost ? `
                <div class="mt-4 flex justify-between text-gray-400 text-sm">
                  <span>${state.name}</span>
                  <span>${state.score} åˆ†</span>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function resultHTML() {
      const rank = getRank();
      const top = state.board.slice(0, 3);
      
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-600 via-orange-500 to-yellow-400 p-4">
          <div class="max-w-lg mx-auto">
            <div class="bg-white/95 rounded-3xl shadow-2xl p-8 text-center mb-4">
              <div class="emoji text-7xl mb-4">ğŸ‰</div>
              <h2 class="text-3xl font-black mb-6">éŠæˆ²çµæŸï¼</h2>
              
              <div class="flex justify-center items-end gap-4 mb-8">
                ${top[1] ? `<div class="text-center"><div class="emoji text-4xl">ğŸ¥ˆ</div><div class="bg-gray-100 rounded-xl px-4 py-3 mt-2"><p class="font-bold">${top[1].name}</p><p class="text-orange-500 font-black">${top[1].score}</p></div></div>` : ''}
                ${top[0] ? `<div class="text-center -mt-4"><div class="emoji text-5xl">ğŸ¥‡</div><div class="bg-yellow-100 rounded-xl px-6 py-4 mt-2 ring-2 ring-yellow-400"><p class="font-bold text-lg">${top[0].name}</p><p class="text-orange-500 font-black text-xl">${top[0].score}</p></div></div>` : ''}
                ${top[2] ? `<div class="text-center"><div class="emoji text-4xl">ğŸ¥‰</div><div class="bg-orange-50 rounded-xl px-4 py-3 mt-2"><p class="font-bold">${top[2].name}</p><p class="text-orange-500 font-black">${top[2].score}</p></div></div>` : ''}
              </div>
              
              ${!state.isHost && rank ? `
                <div class="bg-orange-100 rounded-2xl p-6 mb-6">
                  <p class="text-gray-500">${state.name}</p>
                  <p class="text-4xl font-black text-orange-500">${state.score} åˆ†</p>
                  <p class="text-orange-600 mt-2">ğŸ–ï¸ ç¬¬ ${rank} å</p>
                </div>
              ` : ''}
            </div>
            
            <div class="bg-white/95 rounded-3xl shadow-2xl p-6">
              <h3 class="text-xl font-black text-center mb-4">ğŸ† æ’è¡Œæ¦œ</h3>
              <div class="space-y-2 max-h-64 overflow-y-auto">
                ${state.board.map((p,i) => `
                  <div class="flex justify-between items-center rounded-xl px-4 py-2 ${i<3?'bg-yellow-50':'bg-gray-50'} ${p.name===state.name?'ring-2 ring-orange-400':''}">
                    <div class="flex items-center gap-2">
                      <span class="emoji">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</span>
                      <span class="font-bold">${p.name}</span>
                    </div>
                    <span class="font-black text-orange-500">${p.score}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            ${state.isHost ? `<button id="btnReset" class="w-full mt-4 py-4 bg-gray-800 text-white rounded-2xl font-bold">ğŸ”„ é‡æ–°é–‹å§‹</button>` : ''}
          </div>
        </div>
      `;
    }

    // ========== äº‹ä»¶ ==========
    function bindEvents() {
      const $ = id => document.getElementById(id);
      
      $('btnP')?.addEventListener('click', () => {
        const n = prompt('è«‹è¼¸å…¥åå­—ï¼š', state.name);
        if (n?.trim()) {
          state.name = n.trim();
          state.isHost = false;
          localStorage.setItem('playerName', state.name);
          saveScore();
          state.screen = 'lobby';
          draw();
        }
      });
      
      $('btnH')?.addEventListener('click', () => {
        const p = prompt('å¯†ç¢¼ï¼š');
        if (p === HOST_PWD) {
          state.isHost = true;
          state.name = 'ä¸»æŒäºº';
          state.screen = 'lobby';
          draw();
        } else if (p !== null) {
          alert('å¯†ç¢¼éŒ¯èª¤');
        }
      });
      
      $('btnStart')?.addEventListener('click', startGame);
      $('btnReset')?.addEventListener('click', resetAll);
      $('btnNext')?.addEventListener('click', nextQ);
      
      // è¼¸å…¥æ¡† - ç‰¹åˆ¥è™•ç† iOS
      const ansInput = $('ans');
      if (ansInput) {
        // å„²å­˜è¼¸å…¥å€¼
        ansInput.addEventListener('input', function(e) {
          state.ans = this.value;
        });
        
        // ä¸­æ–‡è¼¸å…¥å®Œæˆ
        ansInput.addEventListener('compositionend', function(e) {
          state.ans = this.value;
        });
        
        // Enter é€å‡º
        ansInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            submit();
          }
        });
        
        // è¨­å®šåˆå§‹å€¼
        ansInput.value = state.ans;
      }
      
      $('btnSub')?.addEventListener('click', submit);
      
      $('btnTip')?.addEventListener('click', () => {
        state.hinted = true;
        draw();
      });
    }

    // ========== å•Ÿå‹• ==========
    initFirebaseConnection();
    draw();
  </script>
</body>
</html>
