<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¿˜å¹´æœƒ Emoji çŒœè¬å¤§è³½</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif; }
    .emoji { font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; }
    input { font-size: 16px !important; } /* Prevent iOS zoom */
    input[type="text"] { -webkit-appearance: none; appearance: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app"></div>

  <script>
    // ========== Firebase è¨­å®š ==========
    const firebaseConfig = {
      apiKey: "AIzaSyAACLIiJcgtzUjJOGwMbvIXvlAY-rAS2Mw",
      authDomain: "project-3076283348011523398.firebaseapp.com",
      databaseURL: "https://project-3076283348011523398-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "project-3076283348011523398",
      storageBucket: "project-3076283348011523398.firebasestorage.app",
      messagingSenderId: "108187479133",
      appId: "1:108187479133:web:f9a75c4b02da8a9c1bf1b4"
    };

    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('Firebase connected');
    } catch(e) {
      console.log('Firebase error:', e);
    }

    // ========== é¡Œåº«ï¼ˆæŒ‰é †åºï¼šç·´ç¿’ â†’ Açµ„ â†’ Bçµ„ â†’ æŒ‘æˆ°ï¼‰==========
    const ALL_QUESTIONS = [
      // ç·´ç¿’é¡Œ (2é¡Œ)
      { emoji: 'ğŸ§…â›½ğŸ«“', answer: 'è”¥æ²¹é¤…', hint: 'æ—©é¤', explain: 'è”¥ï¼‹æ²¹ï¼‹é¤…', round: 'ç·´ç¿’' },
      { emoji: 'ğŸš—ğŸ’¦ğŸğŸ²', answer: 'è»Šæ°´é¦¬é¾', hint: 'æˆèªï¼šç†±é¬§', explain: 'è»Šï¼‹æ°´ï¼‹é¦¬ï¼‹é¾', round: 'ç·´ç¿’' },
      // Açµ„ (7é¡Œ)
      { emoji: 'ğŸ«…ğŸŒ°ğŸŒˆ', answer: 'ç‹åŠ›å®', hint: 'æ­Œæ‰‹', explain: 'ç‹ï¼‹åŠ›ï¼‹å®', round: 'Açµ„' },
      { emoji: 'ğŸ¥—1ï¸âƒ£ğŸŒ³', answer: 'è”¡ä¾æ—', hint: 'æ­Œæ‰‹', explain: 'è”¡ï¼‹ä¾ï¼‹æ—', round: 'Açµ„' },
      { emoji: 'ğŸŒ¹ğŸª¶ğŸ°', answer: 'ç´…æ¯›åŸ', hint: 'å°ç£å¤è¹Ÿ', explain: 'ç´…ï¼‹æ¯›ï¼‹åŸ', round: 'Açµ„' },
      { emoji: 'ğŸ®ğŸ–ğŸœ', answer: 'ç‰›è‚‰éºµ', hint: 'å°ç£ç¾é£Ÿ', explain: 'ç‰›ï¼‹è‚‰ï¼‹éºµ', round: 'Açµ„' },
      { emoji: 'ğŸ·ğŸ©¸ğŸ°', answer: 'è±¬è¡€ç³•', hint: 'å¤œå¸‚å°åƒ', explain: 'è±¬ï¼‹è¡€ï¼‹ç³•', round: 'Açµ„' },
      { emoji: 'ğŸ¦†ğŸ‘…ğŸ§¢', answer: 'é´¨èˆŒå¸½', hint: 'ç©¿æˆ´ç”¨å“', explain: 'é´¨ï¼‹èˆŒï¼‹å¸½', round: 'Açµ„' },
      { emoji: 'ğŸ–¼ï¸ğŸâ•ğŸ¦¶', answer: 'ç•«è›‡æ·»è¶³', hint: 'æˆèª', explain: 'ç•«ï¼‹è›‡ï¼‹æ·»ï¼‹è¶³', round: 'Açµ„' },
      // Bçµ„ (7é¡Œ)
      { emoji: 'ğŸ…ğŸ—£ï¸ğŸğŸ‘', answer: 'è™é ­è›‡å°¾', hint: 'æˆèª', explain: 'è™ï¼‹é ­ï¼‹è›‡ï¼‹å°¾', round: 'Bçµ„' },
      { emoji: 'â˜€ï¸ğŸŒ™ğŸŒŠ', answer: 'æ—¥æœˆæ½­', hint: 'å°ç£æ™¯é»', explain: 'æ—¥ï¼‹æœˆï¼‹æ½­', round: 'Bçµ„' },
      { emoji: 'ğŸ”âœˆï¸ğŸ•ğŸ¦˜', answer: 'é›é£›ç‹—è·³', hint: 'æˆèª', explain: 'é›ï¼‹é£›ï¼‹ç‹—ï¼‹è·³', round: 'Bçµ„' },
      { emoji: 'ğŸŒ¶ï¸ğŸ‘¶ğŸ”', answer: 'è¾£å­é›', hint: 'å·èœ', explain: 'è¾£ï¼‹å­ï¼‹é›', round: 'Bçµ„' },
      { emoji: 'ğŸ‘ğŸ–ğŸ§µ', answer: 'ç¾Šè‚‰ä¸²', hint: 'ç‡’çƒ¤', explain: 'ç¾Šï¼‹è‚‰ï¼‹ä¸²', round: 'Bçµ„' },
      { emoji: 'ğŸ¥¬ğŸ—£ï¸ğŸ“', answer: 'èœè‹±æ–‡', hint: 'å½¢å®¹è©', explain: 'èœï¼‹è‹±ï¼‹æ–‡', round: 'Bçµ„' },
      { emoji: 'ğŸ’£ğŸ”ğŸ¦µ', answer: 'ç‚¸é›è…¿', hint: 'é€Ÿé£Ÿ', explain: 'ç‚¸ï¼‹é›ï¼‹è…¿', round: 'Bçµ„' },
      // æŒ‘æˆ°é¡Œ (2é¡Œ)
      { emoji: 'ğŸ’°ğŸª¡ğŸ„', answer: 'é‡‘é‡è‡', hint: 'è”¬èœ', explain: 'é‡‘ï¼‹é‡ï¼‹è‡', round: 'æŒ‘æˆ°' },
      { emoji: 'ğŸ´ğŸ”œâœ…ğŸ†', answer: 'é¦¬åˆ°æˆåŠŸ', hint: 'ç¥ç¦èª', explain: 'é¦¬ï¼‹åˆ°ï¼‹æˆï¼‹åŠŸ', round: 'æŒ‘æˆ°' },
    ];

    const TOTAL_QUESTIONS = ALL_QUESTIONS.length;
    const HOST_PASSWORD = '2024';
    const QUESTION_TIME = 20; // æ¯é¡Œ20ç§’

    // ========== ç‹€æ…‹ ==========
    let state = {
      screen: 'welcome', // welcome, lobby, game, result
      isHost: false,
      playerName: localStorage.getItem('playerName') || '',
      // éŠæˆ²ç‹€æ…‹ï¼ˆå¾ Firebase åŒæ­¥ï¼‰
      game: {
        started: false,
        currentQuestion: 0,
        timeLeft: QUESTION_TIME,
        showAnswer: false,
        ended: false
      },
      // ç©å®¶æœ¬åœ°ç‹€æ…‹
      myAnswer: '',
      myScore: 0,
      answered: false,
      usedHint: false,
      leaderboard: []
    };

    let timerInterval = null;

    // ========== Firebase åŒæ­¥ ==========
    function initFirebase() {
      if (!db) return;
      
      // ç›£è½éŠæˆ²ç‹€æ…‹
      db.ref('game').on('value', snap => {
        const data = snap.val();
        if (data) {
          const oldQuestion = state.game.currentQuestion;
          const wasShowingAnswer = state.game.showAnswer;
          
          state.game = data;
          
          // é¡Œç›®æ”¹è®Šæ™‚é‡ç½®ç©å®¶ç‹€æ…‹
          if (data.currentQuestion !== oldQuestion) {
            state.myAnswer = '';
            state.answered = false;
            state.usedHint = false;
          }
          
          // é–‹å§‹æ–°é¡Œç›®è¨ˆæ™‚
          if (data.started && !data.showAnswer && !data.ended) {
            if (!state.isHost && data.timeLeft > 0) {
              startLocalTimer();
            }
          }
          
          render();
        }
      });
      
      // ç›£è½æ’è¡Œæ¦œ
      db.ref('leaderboard').on('value', snap => {
        const data = snap.val();
        if (data) {
          state.leaderboard = Object.values(data).sort((a, b) => b.score - a.score);
          render();
        }
      });
    }

    function updateGame(updates) {
      if (!db) return;
      db.ref('game').update(updates);
    }

    function saveMyScore() {
      if (!db || !state.playerName) return;
      const odplayerId = state.playerName.replace(/[.#$\/\[\]]/g, '_');
      db.ref('leaderboard/' + odplayerId).set({
        name: state.playerName,
        score: state.myScore
      });
    }

    function resetGame() {
      if (!db) return;
      if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰åˆ†æ•¸ï¼')) {
        db.ref('game').set({
          started: false,
          currentQuestion: 0,
          timeLeft: QUESTION_TIME,
          showAnswer: false,
          ended: false
        });
        db.ref('leaderboard').remove();
        state.myScore = 0;
        state.myAnswer = '';
        state.answered = false;
      }
    }

    // ========== è¨ˆæ™‚å™¨ ==========
    function startLocalTimer() {
      stopTimer();
      timerInterval = setInterval(() => {
        if (state.game.timeLeft > 0 && !state.game.showAnswer) {
          // æœ¬åœ°å€’æ•¸é¡¯ç¤ºï¼ˆå¯¦éš›æ™‚é–“ç”±ä¸»æŒäººæ§åˆ¶ï¼‰
          render();
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // ä¸»æŒäººè¨ˆæ™‚å™¨
    function hostTimer() {
      stopTimer();
      timerInterval = setInterval(() => {
        if (state.game.timeLeft > 1) {
          updateGame({ timeLeft: state.game.timeLeft - 1 });
        } else {
          // æ™‚é–“åˆ°ï¼Œè‡ªå‹•é¡¯ç¤ºç­”æ¡ˆ
          stopTimer();
          updateGame({ timeLeft: 0, showAnswer: true });
        }
      }, 1000);
    }

    // ========== ä¸»æŒäººæ§åˆ¶ ==========
    function hostStartGame() {
      updateGame({
        started: true,
        currentQuestion: 0,
        timeLeft: QUESTION_TIME,
        showAnswer: false,
        ended: false
      });
      hostTimer();
    }

    function hostNextQuestion() {
      const nextQ = state.game.currentQuestion + 1;
      if (nextQ >= TOTAL_QUESTIONS) {
        // éŠæˆ²çµæŸ
        stopTimer();
        updateGame({ ended: true, showAnswer: false });
      } else {
        // ä¸‹ä¸€é¡Œï¼Œè‡ªå‹•é–‹å§‹è¨ˆæ™‚
        updateGame({
          currentQuestion: nextQ,
          timeLeft: QUESTION_TIME,
          showAnswer: false
        });
        hostTimer();
      }
    }

    // ========== ç©å®¶æäº¤ç­”æ¡ˆ ==========
    function submitAnswer() {
      if (state.answered || !state.myAnswer.trim()) return;
      
      const q = ALL_QUESTIONS[state.game.currentQuestion];
      const correct = state.myAnswer.trim() === q.answer;
      state.answered = true;
      
      if (correct) {
        const timeBonus = Math.floor(state.game.timeLeft / 2);
        const hintPenalty = state.usedHint ? 5 : 0;
        const points = Math.max(10 - hintPenalty + timeBonus, 5);
        state.myScore += points;
        saveMyScore();
      }
      
      render();
    }

    function useHint() {
      state.usedHint = true;
      render();
    }

    // ========== å–å¾—æ’å ==========
    function getMyRank() {
      const idx = state.leaderboard.findIndex(p => p.name === state.playerName);
      return idx >= 0 ? idx + 1 : null;
    }

    // ========== æ¸²æŸ“ ==========
    function render() {
      const app = document.getElementById('app');
      
      switch(state.screen) {
        case 'welcome': app.innerHTML = welcomeScreen(); break;
        case 'lobby': app.innerHTML = lobbyScreen(); break;
        case 'game': app.innerHTML = gameScreen(); break;
        case 'result': app.innerHTML = resultScreen(); break;
        default: app.innerHTML = welcomeScreen();
      }
      
      bindEvents();
    }

    // ========== æ­¡è¿ç•«é¢ ==========
    function welcomeScreen() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-600 via-orange-500 to-yellow-400 flex items-center justify-center p-4">
          <div class="bg-white/95 rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
            <div class="emoji text-7xl mb-4">ğŸŠ</div>
            <h1 class="text-4xl font-black text-gray-800 mb-2">å¿˜å¹´æœƒ</h1>
            <h2 class="text-2xl font-bold text-orange-500 mb-8">Emoji çŒœè¬å¤§è³½</h2>
            <div class="space-y-3">
              <button id="btnPlayer" class="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl font-bold text-xl hover:opacity-90 transition shadow-lg">
                ğŸ‘¤ æˆ‘æ˜¯ç©å®¶
              </button>
              <button id="btnHost" class="w-full py-3 bg-gray-100 text-gray-600 rounded-2xl font-medium hover:bg-gray-200 transition">
                ğŸ¤ ä¸»æŒäººç™»å…¥
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ========== ç­‰å¾…å¤§å»³ ==========
    function lobbyScreen() {
      const playerCount = state.leaderboard.length;
      
      // å¦‚æœéŠæˆ²å·²é–‹å§‹ï¼Œè‡ªå‹•é€²å…¥éŠæˆ²ç•«é¢
      if (state.game.started && !state.game.ended) {
        state.screen = 'game';
        return gameScreen();
      }
      
      // å¦‚æœéŠæˆ²çµæŸï¼Œé¡¯ç¤ºçµæœ
      if (state.game.ended) {
        state.screen = 'result';
        return resultScreen();
      }
      
      if (state.isHost) {
        return `
          <div class="min-h-screen bg-gradient-to-br from-gray-800 to-gray-900 p-4">
            <div class="max-w-lg mx-auto">
              <div class="bg-white rounded-3xl shadow-2xl p-6 mb-4">
                <h2 class="text-2xl font-black text-gray-800 mb-6 text-center">ğŸ¤ ä¸»æŒäººæ§åˆ¶å°</h2>
                
                <div class="bg-blue-50 rounded-2xl p-4 mb-6 text-center">
                  <p class="text-blue-600 font-bold text-lg">ç›®å‰ ${playerCount} ä½ç©å®¶å·²åŠ å…¥</p>
                </div>
                
                <button id="btnStartGame" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl font-bold text-xl hover:opacity-90 transition shadow-lg mb-4">
                  ğŸš€ é–‹å§‹éŠæˆ²
                </button>
                
                <div class="border-t pt-4">
                  <button id="btnReset" class="w-full py-2 text-red-400 text-sm hover:text-red-600 transition">
                    ğŸ—‘ï¸ é‡ç½®éŠæˆ²
                  </button>
                </div>
              </div>
              
              <div class="bg-white/90 rounded-2xl p-4">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ“‹ å·²åŠ å…¥çš„ç©å®¶</h3>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                  ${state.leaderboard.length === 0 ? '<p class="text-gray-400 text-center py-4">ç­‰å¾…ç©å®¶åŠ å…¥...</p>' :
                    state.leaderboard.map(p => `
                      <div class="bg-gray-50 rounded-xl px-4 py-2 font-medium">${p.name}</div>
                    `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="min-h-screen bg-gradient-to-br from-red-600 via-orange-500 to-yellow-400 flex items-center justify-center p-4">
            <div class="bg-white/95 rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
              <div class="emoji text-6xl mb-4">â³</div>
              <h2 class="text-2xl font-black text-gray-800 mb-2">ç­‰å¾…éŠæˆ²é–‹å§‹</h2>
              <p class="text-gray-500 mb-6">ç©å®¶ï¼š${state.playerName}</p>
              
              <div class="bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-6 mb-6">
                <div class="animate-pulse">
                  <div class="w-12 h-12 bg-yellow-300 rounded-full mx-auto mb-3"></div>
                  <p class="text-yellow-700">ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²...</p>
                  <p class="text-yellow-600 text-sm mt-2">ç›®å‰ ${playerCount} ä½ç©å®¶</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    }

    // ========== éŠæˆ²ç•«é¢ ==========
    function gameScreen() {
      // éŠæˆ²çµæŸ
      if (state.game.ended) {
        state.screen = 'result';
        return resultScreen();
      }
      
      // éŠæˆ²æœªé–‹å§‹
      if (!state.game.started) {
        state.screen = 'lobby';
        return lobbyScreen();
      }
      
      const q = ALL_QUESTIONS[state.game.currentQuestion];
      const progress = ((state.game.currentQuestion + 1) / TOTAL_QUESTIONS) * 100;
      const timeLeft = state.game.timeLeft;
      const showAnswer = state.game.showAnswer;
      
      // åˆ¤æ–·ç©å®¶æ˜¯å¦ç­”å°
      const isCorrect = state.answered && state.myAnswer.trim() === q.answer;
      
      // é¡¯ç¤ºç­”æ¡ˆç•«é¢ï¼ˆä¸»æŒäººå’Œç©å®¶éƒ½ä¸€æ¨£ï¼‰
      if (showAnswer) {
        return `
          <div class="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-600 p-4">
            <div class="max-w-2xl mx-auto">
              <!-- é€²åº¦ -->
              <div class="bg-white/20 rounded-full h-2 mb-4">
                <div class="bg-white h-full rounded-full transition-all" style="width:${progress}%"></div>
              </div>
              <div class="text-white text-center mb-4">
                <span class="font-bold">${q.round}</span>
                <span class="opacity-70 ml-2">ç¬¬ ${state.game.currentQuestion + 1}/${TOTAL_QUESTIONS} é¡Œ</span>
              </div>
              
              <!-- é¡Œç›® + ç­”æ¡ˆ -->
              <div class="bg-white rounded-3xl shadow-2xl p-6 mb-4">
                <div class="text-center mb-6">
                  <div class="emoji text-6xl md:text-7xl tracking-wider mb-4">${q.emoji}</div>
                </div>
                
                <div class="bg-green-100 border-2 border-green-400 rounded-2xl p-6 text-center mb-4">
                  <p class="text-green-600 font-bold mb-2">âœ… æ­£ç¢ºç­”æ¡ˆ</p>
                  <p class="text-4xl font-black text-green-700">${q.answer}</p>
                  <p class="text-green-600 mt-2">${q.explain}</p>
                </div>
                
                ${!state.isHost ? `
                  <div class="text-center py-2 rounded-xl ${isCorrect ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'} font-bold">
                    ${isCorrect ? 'ğŸ‰ ä½ ç­”å°äº†ï¼' : (state.answered ? 'âŒ ç­”éŒ¯äº†' : 'â° æœªä½œç­”')}
                  </div>
                ` : ''}
              </div>
              
              <!-- æ’è¡Œæ¦œ -->
              <div class="bg-white rounded-3xl shadow-2xl p-6 mb-4">
                <h3 class="text-xl font-black text-center mb-4">ğŸ† å³æ™‚æ’è¡Œæ¦œ</h3>
                <div class="space-y-2 max-h-48 overflow-y-auto">
                  ${state.leaderboard.slice(0, 10).map((p, i) => `
                    <div class="flex items-center justify-between rounded-xl px-4 py-2 ${i < 3 ? 'bg-gradient-to-r from-yellow-50 to-orange-50' : 'bg-gray-50'} ${p.name === state.playerName ? 'ring-2 ring-orange-400' : ''}">
                      <div class="flex items-center gap-3">
                        <span class="emoji text-xl w-8">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</span>
                        <span class="font-bold">${p.name}</span>
                      </div>
                      <span class="font-black text-orange-500">${p.score}</span>
                    </div>
                  `).join('')}
                  ${state.leaderboard.length === 0 ? '<p class="text-gray-400 text-center py-4">å°šç„¡åˆ†æ•¸</p>' : ''}
                </div>
              </div>
              
              <!-- ä¸»æŒäººï¼šä¸‹ä¸€é¡ŒæŒ‰éˆ• -->
              ${state.isHost ? `
                <button id="btnNextQuestion" class="w-full py-4 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl font-bold text-xl hover:opacity-90 transition shadow-lg">
                  ${state.game.currentQuestion + 1 >= TOTAL_QUESTIONS ? 'ğŸ æŸ¥çœ‹æœ€çµ‚çµæœ' : 'â¡ï¸ ä¸‹ä¸€é¡Œ'}
                </button>
              ` : `
                <div class="text-center text-white/80">
                  â³ ç­‰å¾…ä¸»æŒäººé€²å…¥ä¸‹ä¸€é¡Œ...
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      // ç­”é¡Œç•«é¢
      return `
        <div class="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-600 p-4">
          <div class="max-w-lg mx-auto">
            <!-- é€²åº¦ -->
            <div class="bg-white/20 rounded-full h-2 mb-4">
              <div class="bg-white h-full rounded-full transition-all" style="width:${progress}%"></div>
            </div>
            
            <!-- é¡Œç›®è³‡è¨Š -->
            <div class="flex justify-between items-center text-white mb-4">
              <div>
                <span class="font-bold">${q.round}</span>
                <span class="opacity-70 ml-2">${state.game.currentQuestion + 1}/${TOTAL_QUESTIONS}</span>
              </div>
              <div class="text-3xl font-black ${timeLeft <= 5 ? 'text-red-300 animate-pulse' : ''}">
                â±ï¸ ${timeLeft}s
              </div>
            </div>
            
            <!-- é¡Œç›® -->
            <div class="bg-white rounded-3xl shadow-2xl p-6 mb-4">
              <div class="text-center mb-6">
                <div class="emoji text-6xl md:text-7xl tracking-wider">${q.emoji}</div>
                ${state.usedHint ? `
                  <div class="mt-4 inline-block bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full text-sm">
                    ğŸ’¡ æç¤ºï¼š${q.hint}
                  </div>
                ` : ''}
              </div>
              
              ${!state.isHost ? `
                <!-- ç©å®¶è¼¸å…¥å€ -->
                ${state.answered ? `
                  <div class="bg-blue-50 rounded-2xl p-4 text-center">
                    <p class="text-blue-600 font-bold">å·²é€å‡ºç­”æ¡ˆï¼š${state.myAnswer}</p>
                    <p class="text-blue-500 text-sm mt-1">ç­‰å¾…æ™‚é–“çµæŸæ­æ›‰ç­”æ¡ˆ...</p>
                  </div>
                ` : `
                  <div class="space-y-3">
                    <input type="text" id="answerInput" 
                      value="${state.myAnswer}"
                      placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ..."
                      autocomplete="off"
                      autocorrect="off"
                      autocapitalize="off"
                      spellcheck="false"
                      enterkeyhint="send"
                      class="w-full px-5 py-4 border-2 border-gray-200 rounded-2xl text-xl text-center focus:border-orange-400 focus:outline-none font-medium">
                    <div class="flex gap-3">
                      <button id="btnSubmit" class="flex-1 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl font-bold text-lg hover:opacity-90 transition shadow-lg">
                        é€å‡ºç­”æ¡ˆ
                      </button>
                      <button id="btnHint" ${state.usedHint ? 'disabled' : ''} class="px-5 py-4 bg-yellow-400 text-yellow-900 rounded-2xl font-bold text-lg hover:bg-yellow-500 disabled:opacity-40 transition">
                        ğŸ’¡
                      </button>
                    </div>
                  </div>
                `}
                
                <div class="mt-4 flex justify-between text-gray-400 text-sm">
                  <span>${state.playerName}</span>
                  <span>ç›®å‰ ${state.myScore} åˆ†</span>
                </div>
              ` : `
                <!-- ä¸»æŒäººçœ‹åˆ°ç­”æ¡ˆ -->
                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-2xl p-4 text-center">
                  <p class="text-yellow-600 text-sm mb-1">ğŸ“‹ ç­”æ¡ˆ</p>
                  <p class="text-2xl font-black text-yellow-700">${q.answer}</p>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // ========== çµæœç•«é¢ ==========
    function resultScreen() {
      const rank = getMyRank();
      const top3 = state.leaderboard.slice(0, 3);
      
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-600 via-orange-500 to-yellow-400 p-4">
          <div class="max-w-lg mx-auto">
            <div class="bg-white/95 rounded-3xl shadow-2xl p-8 text-center mb-4">
              <div class="emoji text-7xl mb-4">ğŸ‰</div>
              <h2 class="text-3xl font-black text-gray-800 mb-6">éŠæˆ²çµæŸï¼</h2>
              
              <!-- å‰ä¸‰å -->
              <div class="flex justify-center items-end gap-4 mb-8">
                ${top3[1] ? `
                  <div class="text-center">
                    <div class="emoji text-4xl">ğŸ¥ˆ</div>
                    <div class="bg-gray-100 rounded-xl px-4 py-3 mt-2">
                      <p class="font-bold text-gray-700">${top3[1].name}</p>
                      <p class="text-orange-500 font-black">${top3[1].score}</p>
                    </div>
                  </div>
                ` : ''}
                ${top3[0] ? `
                  <div class="text-center -mt-4">
                    <div class="emoji text-5xl">ğŸ¥‡</div>
                    <div class="bg-yellow-100 rounded-xl px-6 py-4 mt-2 ring-2 ring-yellow-400">
                      <p class="font-bold text-gray-700 text-lg">${top3[0].name}</p>
                      <p class="text-orange-500 font-black text-xl">${top3[0].score}</p>
                    </div>
                  </div>
                ` : ''}
                ${top3[2] ? `
                  <div class="text-center">
                    <div class="emoji text-4xl">ğŸ¥‰</div>
                    <div class="bg-orange-50 rounded-xl px-4 py-3 mt-2">
                      <p class="font-bold text-gray-700">${top3[2].name}</p>
                      <p class="text-orange-500 font-black">${top3[2].score}</p>
                    </div>
                  </div>
                ` : ''}
              </div>
              
              ${!state.isHost && rank ? `
                <div class="bg-gradient-to-br from-orange-100 to-yellow-100 rounded-2xl p-6 mb-6">
                  <p class="text-gray-500">${state.playerName}</p>
                  <p class="text-4xl font-black text-orange-500">${state.myScore} åˆ†</p>
                  <p class="text-orange-600 mt-2">ğŸ–ï¸ ç¬¬ ${rank} å</p>
                </div>
              ` : ''}
            </div>
            
            <!-- å®Œæ•´æ’è¡Œæ¦œ -->
            <div class="bg-white/95 rounded-3xl shadow-2xl p-6">
              <h3 class="text-xl font-black text-center mb-4">ğŸ† å®Œæ•´æ’è¡Œæ¦œ</h3>
              <div class="space-y-2 max-h-64 overflow-y-auto">
                ${state.leaderboard.map((p, i) => `
                  <div class="flex items-center justify-between rounded-xl px-4 py-2 ${i < 3 ? 'bg-gradient-to-r from-yellow-50 to-orange-50' : 'bg-gray-50'} ${p.name === state.playerName ? 'ring-2 ring-orange-400' : ''}">
                    <div class="flex items-center gap-3">
                      <span class="emoji text-xl w-8">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</span>
                      <span class="font-bold">${p.name}</span>
                    </div>
                    <span class="font-black text-orange-500">${p.score}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            ${state.isHost ? `
              <button id="btnReset" class="w-full mt-4 py-4 bg-gray-800 text-white rounded-2xl font-bold hover:bg-gray-700 transition">
                ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ========== äº‹ä»¶ç¶å®š ==========
    function bindEvents() {
      const $ = id => document.getElementById(id);
      
      // æ­¡è¿é 
      $('btnPlayer')?.addEventListener('click', () => {
        const name = prompt('è«‹è¼¸å…¥ä½ çš„åå­—ï¼š', state.playerName);
        if (name && name.trim()) {
          state.playerName = name.trim();
          state.isHost = false;
          localStorage.setItem('playerName', state.playerName);
          // åŠ å…¥æ’è¡Œæ¦œï¼ˆåˆå§‹0åˆ†ï¼‰
          saveMyScore();
          state.screen = 'lobby';
          render();
        }
      });
      
      $('btnHost')?.addEventListener('click', () => {
        const pwd = prompt('è«‹è¼¸å…¥ä¸»æŒäººå¯†ç¢¼ï¼š');
        if (pwd === HOST_PASSWORD) {
          state.isHost = true;
          state.playerName = 'ä¸»æŒäºº';
          state.screen = 'lobby';
          render();
        } else if (pwd !== null) {
          alert('å¯†ç¢¼éŒ¯èª¤');
        }
      });
      
      // å¤§å»³
      $('btnStartGame')?.addEventListener('click', hostStartGame);
      $('btnReset')?.addEventListener('click', resetGame);
      
      // éŠæˆ²ä¸­
      $('answerInput')?.addEventListener('input', e => {
        state.myAnswer = e.target.value;
      });
      
      $('answerInput')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitAnswer();
        }
      });
      
      // è™•ç†ä¸­æ–‡è¼¸å…¥æ³•
      $('answerInput')?.addEventListener('compositionend', e => {
        state.myAnswer = e.target.value;
      });
      
      $('btnSubmit')?.addEventListener('click', submitAnswer);
      $('btnHint')?.addEventListener('click', useHint);
      $('btnNextQuestion')?.addEventListener('click', hostNextQuestion);
      
      // è‡ªå‹•èšç„¦è¼¸å…¥æ¡†
      const input = $('answerInput');
      if (input && !state.answered) {
        setTimeout(() => input.focus(), 100);
      }
    }

    // ========== åˆå§‹åŒ– ==========
    initFirebase();
    render();
  </script>
</body>
</html>
